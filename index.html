import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from 'firebase/firestore';

// Global variables provided by the Canvas environment
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Component for the printable suspension form
const PrintableSuspensionForm = React.forwardRef(({ data }, ref) => {
    if (!data) return null;

    return (
        <div ref={ref} className="printable-content p-8" style={{ display: 'none' }}>
            {/* First Copy */}
            <div className="mb-12 border-b-2 border-dashed pb-8">
                <h2 className="text-2xl font-bold text-center mb-4">學童午餐停餐申請表 (學校留存聯)</h2>
                <div className="grid grid-cols-2 gap-4 text-lg">
                    <div><span className="font-semibold">年級:</span> {data.grade}</div>
                    <div><span className="font-semibold">班級:</span> {data.class}</div>
                    <div><span className="font-semibold">座號:</span> {data.studentId}</div>
                    <div><span className="font-semibold">停餐人數:</span> {data.numberOfStudents} 人</div>
                    <div className="col-span-2">
                        <span className="font-semibold">學童姓名:</span> {data.studentNames?.filter(name => name).join(', ')}
                    </div>
                    <div className="col-span-2">
                        <span className="font-semibold">停餐日期:</span> {data.startDate} 到 {data.endDate}
                    </div>
                    <div className="col-span-2">
                        <span className="font-semibold">實際停餐天數:</span> {data.actualSuspensionDays} 天
                    </div>
                    <div className="col-span-2">
                        <span className="font-semibold">退費金額:</span> {data.refundAmount} 元
                    </div>
                    <div className="col-span-2">
                        <span className="font-semibold">停餐原因:</span> {data.reason}
                    </div>
                    <div className="col-span-2 mt-4 text-right text-sm text-gray-600">
                        申請日期: {new Date(data.timestamp?.toDate()).toLocaleDateString()}
                    </div>
                </div>
            </div>

            {/* Second Copy */}
            <div>
                <h2 className="text-2xl font-bold text-center mb-4">學童午餐停餐申請表 (家長留存聯)</h2>
                <div className="grid grid-cols-2 gap-4 text-lg">
                    <div><span className="font-semibold">年級:</span> {data.grade}</div>
                    <div><span className="font-semibold">班級:</span> {data.class}</div>
                    <div><span className="font-semibold">座號:</span> {data.studentId}</div>
                    <div><span className="font-semibold">停餐人數:</span> {data.numberOfStudents} 人</div>
                    <div className="col-span-2">
                        <span className="font-semibold">學童姓名:</span> {data.studentNames?.filter(name => name).join(', ')}
                    </div>
                    <div className="col-span-2">
                        <span className="font-semibold">停餐日期:</span> {data.startDate} 到 {data.endDate}
                    </div>
                    <div className="col-span-2">
                        <span className="font-semibold">實際停餐天數:</span> {data.actualSuspensionDays} 天
                    </div>
                    <div className="col-span-2">
                        <span className="font-semibold">退費金額:</span> {data.refundAmount} 元
                    </div>
                    <div className="col-span-2">
                        <span className="font-semibold">停餐原因:</span> {data.reason}
                    </div>
                    <div className="col-span-2 mt-4 text-right text-sm text-gray-600">
                        申請日期: {new Date(data.timestamp?.toDate()).toLocaleDateString()}
                    </div>
                </div>
            </div>
        </div>
    );
});

function App() {
    // State for Firebase instances and user ID
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);

    // State for navigation
    const [currentPage, setCurrentPage] = useState('order'); // 'order', 'suspension', 'health', 'documents'

    // State for form data (example for order form)
    const [orderForm, setOrderForm] = useState({
        grade: '',
        class: '',
        studentId: '',
        studentName: '',
        parentName: '',
        isOrdering: 'yes', // 'yes' or 'no'
        diet: 'meat', // 'meat' or 'vegetarian'
        milkDay: 'milk', // 'milk' or 'fruit'
    });

    // State for suspension form data
    const [suspensionForm, setSuspensionForm] = useState({
        grade: '',
        class: '',
        studentId: '',
        numberOfStudents: '1', // Changed to string for select value
        studentNames: [''], // Initialize with one empty string for 1 student
        startDate: '',
        endDate: '',
        reason: '',
        refundAmount: 0, // Calculated refund amount
    });

    // State for health report form data
    const [healthForm, setHealthForm] = useState({
        height: '',
        weight: '',
        visionLeft: '',
        visionRight: '',
    });

    // State for displaying submitted data
    const [submittedOrders, setSubmittedOrders] = useState([]);
    const [submittedSuspensions, setSubmittedSuspensions] = useState([]);
    const [submittedHealthReports, setSubmittedHealthReports] = useState([]);

    // State for print functionality
    const [printData, setPrintData] = useState(null);
    const printableRef = useRef();

    // Calculate the minimum allowed start date (today + 3 working days excluding holidays)
    const [minAllowedStartDate, setMinAllowedStartDate] = useState('');

    useEffect(() => {
        const calculateMinDate = () => {
            let date = new Date();
            let workingDaysCount = 0;
            // Iterate until 3 working days are found
            while (workingDaysCount < 3) {
                date.setDate(date.getDate() + 1); // Move to next day
                const dayOfWeek = date.getDay(); // 0 = Sunday, 6 = Saturday
                const currentMonth = date.getMonth(); // 0-indexed
                const currentDay = date.getDate();

                const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
                // Summer Vacation: July 1st to August 20th (months 6 and 7)
                const isSummerVacation = (currentMonth === 6 && currentDay >= 1) || (currentMonth === 7 && currentDay <= 20);
                // Winter Vacation: January 20th to February 20th (months 0 and 1)
                const isWinterVacation = (currentMonth === 0 && currentDay >= 20) || (currentMonth === 1 && currentDay <= 20);

                if (!isWeekend && !isSummerVacation && !isWinterVacation) {
                    workingDaysCount++;
                }
            }
            // Format to YYYY-MM-DD
            setMinAllowedStartDate(date.toISOString().split('T')[0]);
        };
        calculateMinDate();
    }, []);


    // Initialize Firebase and set up auth listener
    useEffect(() => {
        const app = initializeApp(firebaseConfig);
        const firestoreDb = getFirestore(app);
        const firebaseAuth = getAuth(app);

        setDb(firestoreDb);
        setAuth(firebaseAuth);

        const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
            if (user) {
                setUserId(user.uid);
            } else {
                // Sign in anonymously if no initial token or user is not authenticated
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(firebaseAuth, initialAuthToken);
                    } else {
                        await signInAnonymously(firebaseAuth);
                    }
                    setUserId(firebaseAuth.currentUser?.uid || crypto.randomUUID()); // Fallback to random UUID if auth.currentUser is null
                } catch (error) {
                    console.error("Firebase authentication failed:", error);
                    setUserId(crypto.randomUUID()); // Use a random UUID if anonymous sign-in fails
                }
            }
            setIsAuthReady(true);
        });

        return () => unsubscribe();
    }, []);

    // Fetch data when auth is ready and userId is set
    useEffect(() => {
        if (isAuthReady && db && userId) {
            // Fetch lunch orders
            const ordersCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/lunchOrders`);
            const unsubscribeOrders = onSnapshot(ordersCollectionRef, (snapshot) => {
                const ordersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setSubmittedOrders(ordersData);
            }, (error) => {
                console.error("Error fetching lunch orders:", error);
            });

            // Fetch lunch suspensions
            const suspensionsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/lunchSuspensions`);
            const unsubscribeSuspensions = onSnapshot(suspensionsCollectionRef, (snapshot) => {
                const suspensionsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setSubmittedSuspensions(suspensionsData);
            }, (error) => {
                console.error("Error fetching lunch suspensions:", error);
            });

            // Fetch health reports
            const healthReportsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/healthReports`);
            const unsubscribeHealthReports = onSnapshot(healthReportsCollectionRef, (snapshot) => {
                const healthData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setSubmittedHealthReports(healthData);
            }, (error) => {
                console.error("Error fetching health reports:", error);
            });

            return () => {
                unsubscribeOrders();
                unsubscribeSuspensions();
                unsubscribeHealthReports();
            };
        }
    }, [isAuthReady, db, userId]);

    // Handle form input changes
    const handleOrderFormChange = (e) => {
        const { name, value } = e.target;
        setOrderForm(prev => ({ ...prev, [name]: value }));
    };

    const handleSuspensionFormChange = (e) => {
        const { name, value } = e.target;
        setSuspensionForm(prev => ({ ...prev, [name]: value }));
    };

    const handleNumberOfStudentsChange = (e) => {
        const num = parseInt(e.target.value) || 1; // Parse to int, default to 1
        setSuspensionForm(prev => ({
            ...prev,
            numberOfStudents: String(num), // Store as string for select
            studentNames: Array(num).fill('').map((_, i) => prev.studentNames[i] || ''), // Preserve existing names
        }));
    };

    const handleStudentNameChange = (index, value) => {
        const newNames = [...suspensionForm.studentNames];
        newNames[index] = value;
        setSuspensionForm(prev => ({ ...prev, studentNames: newNames }));
    };

    const handleHealthFormChange = (e) => {
        const { name, value } = e.target;
        setHealthForm(prev => ({ ...prev, [name]: value }));
    };

    // Handle form submissions
    const handleOrderSubmit = async (e) => {
        e.preventDefault();
        if (!db || !userId) {
            console.error("Firestore or User ID not available.");
            return;
        }
        try {
            await addDoc(collection(db, `artifacts/${appId}/users/${userId}/lunchOrders`), {
                ...orderForm,
                timestamp: new Date(),
            });
            alertMessage("午餐意願調查表已成功送出！");
            // Reset form
            setOrderForm({
                grade: '', class: '', studentId: '', studentName: '', parentName: '',
                isOrdering: 'yes', diet: 'meat', milkDay: 'milk',
            });
        } catch (e) {
            console.error("新增午餐意願調查表時發生錯誤: ", e);
            alertMessage("送出失敗，請重試。");
        }
    };

    const handleSuspensionSubmit = async (e) => {
        e.preventDefault();
        if (!db || !userId) {
            console.error("Firestore or User ID not available.");
            return;
        }

        const startDate = new Date(suspensionForm.startDate);
        const endDate = new Date(suspensionForm.endDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Normalize today's date to start of day

        // Date validation: start date must be at least 3 working days from now
        const minAllowedDateObj = new Date(minAllowedStartDate);
        if (startDate < minAllowedDateObj) {
            alertMessage(`停餐開始日期必須在 ${minAllowedStartDate} 或之後 (需提前3個工作天申請)。`);
            return;
        }

        if (isNaN(startDate.getTime()) || isNaN(endDate.getTime()) || startDate > endDate) {
            alertMessage("請輸入有效的停餐日期範圍。");
            return;
        }

        let actualSuspensionDays = 0;
        const lunchPricePerDay = 65; // 65元/餐

        let currentDate = new Date(startDate);
        while (currentDate <= endDate) {
            const dayOfWeek = currentDate.getDay(); // 0 = Sunday, 6 = Saturday
            const currentMonth = currentDate.getMonth(); // 0-indexed
            const currentDay = currentDate.getDate();

            // Check for weekends
            const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);

            // Check for Summer Vacation (July 1st to August 20th)
            const isSummerVacation = (currentMonth === 6 && currentDay >= 1) || // July (Month 6) 1st onwards
                                     (currentMonth === 7 && currentDay <= 20); // August (Month 7) 20th or earlier

            // Check for Winter Vacation (January 20th to February 20th)
            const isWinterVacation = (currentMonth === 0 && currentDay >= 20) || // January (Month 0) 20th onwards
                                     (currentMonth === 1 && currentDay <= 20); // February (Month 1) 20th or earlier

            if (!isWeekend && !isSummerVacation && !isWinterVacation) {
                actualSuspensionDays++;
            }
            currentDate.setDate(currentDate.getDate() + 1); // Move to next day
        }

        const numStudents = parseInt(suspensionForm.numberOfStudents);
        const calculatedRefundAmount = actualSuspensionDays * numStudents * lunchPricePerDay;

        try {
            const docRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/lunchSuspensions`), {
                ...suspensionForm,
                actualSuspensionDays: actualSuspensionDays,
                refundAmount: calculatedRefundAmount,
                timestamp: new Date(),
                // Filter out empty student names before saving
                studentNames: suspensionForm.studentNames.slice(0, numStudents).filter(name => name.trim() !== ''),
            });
            alertMessage(`午餐停餐申請表已成功送出！預計停餐 ${actualSuspensionDays} 天，退費金額 ${calculatedRefundAmount} 元。`);

            // Set data for printing the just submitted form
            setPrintData({
                ...suspensionForm,
                actualSuspensionDays: actualSuspensionDays,
                refundAmount: calculatedRefundAmount,
                timestamp: new Date(),
                studentNames: suspensionForm.studentNames.slice(0, numStudents).filter(name => name.trim() !== ''),
            });

            // Reset form
            setSuspensionForm({
                grade: '', class: '', studentId: '', numberOfStudents: '1', studentNames: [''],
                startDate: '', endDate: '', reason: '', refundAmount: 0,
            });
        } catch (e) {
            console.error("新增午餐停餐申請表時發生錯誤: ", e);
            alertMessage("送出失敗，請重試。");
        }
    };

    const handleHealthSubmit = async (e) => {
        e.preventDefault();
        if (!db || !userId) {
            console.error("Firestore or User ID not available.");
            return;
        }
        try {
            await addDoc(collection(db, `artifacts/${appId}/users/${userId}/healthReports`), {
                ...healthForm,
                timestamp: new Date(),
            });
            alertMessage("學童健康資料已成功送出！");
            // Reset form
            setHealthForm({
                height: '', weight: '', visionLeft: '', visionRight: '',
            });
        } catch (e) {
            console.error("新增學童健康資料時發生錯誤: ", e);
            alertMessage("送出失敗，請重試。");
        }
    };

    // Handle print button click
    const handlePrint = () => {
        if (printData) {
            // Trigger print
            window.print();
        } else {
            alertMessage("請先提交停餐申請表才能列印。");
        }
    };

    // Custom alert message box (instead of window.alert)
    const alertMessage = (message) => {
        const alertBox = document.createElement('div');
        alertBox.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-blue-500 text-white p-4 rounded-lg shadow-lg z-50';
        alertBox.textContent = message;
        document.body.appendChild(alertBox);
        setTimeout(() => {
            document.body.removeChild(alertBox);
        }, 3000);
    };

    // Helper function to render form fields
    const renderFormField = (label, name, value, onChange, type = 'text', options = [], placeholder = '', min = '') => (
        <div className="mb-4">
            <label htmlFor={name} className="block text-gray-700 text-sm font-bold mb-2">
                {label}
            </label>
            {type === 'select' ? (
                <select
                    id={name}
                    name={name}
                    value={value}
                    onChange={onChange}
                    className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                >
                    {options.map(option => (
                        <option key={option.value} value={option.value}>{option.label}</option>
                    ))}
                </select>
            ) : type === 'textarea' ? (
                <textarea
                    id={name}
                    name={name}
                    value={value}
                    onChange={onChange}
                    placeholder={placeholder}
                    className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-24"
                />
            ) : (
                <input
                    type={type}
                    id={name}
                    name={name}
                    value={value}
                    onChange={onChange}
                    placeholder={placeholder}
                    min={min} // Apply min attribute for date inputs
                    className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                />
            )}
        </div>
    );

    return (
        <div className="min-h-screen bg-gray-100 font-sans antialiased flex flex-col items-center p-4">
            {/* Tailwind CSS CDN */}
            <script src="https://cdn.tailwindcss.com"></script>
            {/* Font Inter */}
            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
            <style>
                {`
                body {
                    font-family: 'Inter', sans-serif;
                }
                .btn-primary {
                    background-color: #4CAF50; /* Green */
                    color: white;
                    padding: 10px 20px;
                    border-radius: 8px;
                    transition: background-color 0.3s ease;
                }
                .btn-primary:hover {
                    background-color: #45a049;
                }
                /* Print styles */
                @media print {
                    body > *:not(.printable-content) {
                        display: none !important;
                    }
                    .printable-content {
                        display: block !important;
                        width: 100%;
                        margin: 0;
                        padding: 0;
                    }
                    .printable-content h2 {
                        font-size: 1.5rem;
                        margin-bottom: 1rem;
                    }
                    .printable-content .grid {
                        display: grid;
                        grid-template-columns: repeat(2, minmax(0, 1fr));
                        gap: 1rem;
                    }
                    .printable-content .col-span-2 {
                        grid-column: span 2 / span 2;
                    }
                    .printable-content .mb-12 {
                        margin-bottom: 3rem;
                    }
                    .printable-content .border-b-2 {
                        border-bottom-width: 2px;
                    }
                    .printable-content .border-dashed {
                        border-style: dashed;
                    }
                    .printable-content .pb-8 {
                        padding-bottom: 2rem;
                    }
                }
                `}
            </style>

            <header className="w-full max-w-4xl bg-white shadow-md rounded-lg p-6 mb-8 text-center">
                <h1 className="text-3xl md:text-4xl font-bold text-gray-800 mb-2">國小學童午餐資料管理系統</h1>
                <p className="text-gray-600">方便學童家長及學校衛生組進行午餐相關資料填報與管理</p>
                {userId && (
                    <p className="text-sm text-gray-500 mt-2">
                        您的用戶ID: <span className="font-mono break-all">{userId}</span>
                    </p>
                )}
            </header>

            {/* Navigation */}
            <nav className="w-full max-w-4xl bg-white shadow-md rounded-lg p-4 mb-8 flex flex-wrap justify-center gap-4">
                <button
                    onClick={() => setCurrentPage('order')}
                    className={`px-6 py-3 rounded-lg font-semibold transition-colors duration-200 ${
                        currentPage === 'order' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800 hover:bg-blue-100'
                    }`}
                >
                    午餐意願調查
                </button>
                <button
                    onClick={() => setCurrentPage('suspension')}
                    className={`px-6 py-3 rounded-lg font-semibold transition-colors duration-200 ${
                        currentPage === 'suspension' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800 hover:bg-blue-100'
                    }`}
                >
                    午餐停餐申請
                </button>
                <button
                    onClick={() => setCurrentPage('health')}
                    className={`px-6 py-3 rounded-lg font-semibold transition-colors duration-200 ${
                        currentPage === 'health' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800 hover:bg-blue-100'
                    }`}
                >
                    學童健康填報
                </button>
                <button
                    onClick={() => setCurrentPage('documents')}
                    className={`px-6 py-3 rounded-lg font-semibold transition-colors duration-200 ${
                        currentPage === 'documents' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800 hover:bg-blue-100'
                    }`}
                >
                    衛生組文件
                </button>
            </nav>

            <main className="w-full max-w-4xl bg-white shadow-md rounded-lg p-8">
                {/* Lunch Order Form */}
                {currentPage === 'order' && (
                    <section>
                        <h2 className="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">學童午餐意願調查表</h2>
                        <form onSubmit={handleOrderSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                            {renderFormField('年級', 'grade', orderForm.grade, handleOrderFormChange, 'number', [], '請輸入年級')}
                            {renderFormField('班級', 'class', orderForm.class, handleOrderFormChange, 'text', [], '請輸入班級')}
                            {renderFormField('座號/學號', 'studentId', orderForm.studentId, handleOrderFormChange, 'text', [], '請輸入座號或學號')}
                            {renderFormField('學童姓名', 'studentName', orderForm.studentName, handleOrderFormChange, 'text', [], '請輸入學童姓名')}
                            {renderFormField('家長姓名', 'parentName', orderForm.parentName, handleOrderFormChange, 'text', [], '請輸入家長姓名')}
                            {renderFormField(
                                '是否訂購',
                                'isOrdering',
                                orderForm.isOrdering,
                                handleOrderFormChange,
                                'select',
                                [{ value: 'yes', label: '是' }, { value: 'no', label: '否' }]
                            )}
                            {renderFormField(
                                '葷素食',
                                'diet',
                                orderForm.diet,
                                handleOrderFormChange,
                                'select',
                                [{ value: 'meat', label: '葷食' }, { value: 'vegetarian', label: '素食' }]
                            )}
                            {renderFormField(
                                '牛奶日',
                                'milkDay',
                                orderForm.milkDay,
                                handleOrderFormChange,
                                'select',
                                [{ value: 'milk', label: '牛奶' }, { value: 'fruit', label: '換水果' }]
                            )}
                            <div className="md:col-span-2 flex justify-center mt-6">
                                <button
                                    type="submit"
                                    className="btn-primary px-8 py-3 text-lg font-semibold rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                >
                                    送出午餐意願
                                </button>
                            </div>
                        </form>

                        <h3 className="text-xl font-bold text-gray-800 mt-10 mb-4 border-b pb-2">已送出的午餐意願</h3>
                        {submittedOrders.length === 0 ? (
                            <p className="text-gray-600">目前沒有已送出的午餐意願資料。</p>
                        ) : (
                            <div className="overflow-x-auto">
                                <table className="min-w-full bg-white border border-gray-200 rounded-lg">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">年級</th>
                                            <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">班級</th>
                                            <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">學童姓名</th>
                                            <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">是否訂購</th>
                                            <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">葷素食</th>
                                            <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">牛奶日</th>
                                            <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">送出時間</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-200">
                                        {submittedOrders.map((order) => (
                                            <tr key={order.id}>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900">{order.grade}</td>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900">{order.class}</td>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900">{order.studentName}</td>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900">{order.isOrdering === 'yes' ? '是' : '否'}</td>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900">{order.diet === 'meat' ? '葷食' : '素食'}</td>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900">{order.milkDay === 'milk' ? '牛奶' : '水果'}</td>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900">
                                                    {order.timestamp?.toDate().toLocaleString() || 'N/A'}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </section>
                )}

                {/* Lunch Suspension Form */}
                {currentPage === 'suspension' && (
                    <section>
                        <h2 className="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">學童午餐停餐申請表</h2>
                        <form onSubmit={handleSuspensionSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                            {renderFormField('年級', 'grade', suspensionForm.grade, handleSuspensionFormChange, 'number', [], '請輸入年級')}
                            {renderFormField('班級', 'class', suspensionForm.class, handleSuspensionFormChange, 'text', [], '請輸入班級')}
                            {renderFormField('座號', 'studentId', suspensionForm.studentId, handleSuspensionFormChange, 'text', [], '請輸入座號')}
                            {renderFormField(
                                '停餐人數',
                                'numberOfStudents',
                                suspensionForm.numberOfStudents,
                                handleNumberOfStudentsChange,
                                'select',
                                Array.from({ length: 5 }, (_, i) => ({ value: String(i + 1), label: String(i + 1) }))
                            )}
                            <div className="md:col-span-2">
                                <label className="block text-gray-700 text-sm font-bold mb-2">
                                    姓名 (可容許五個人之內共用)
                                </label>
                                {/* Dynamically render student name input fields based on numberOfStudents */}
                                {Array.from({ length: parseInt(suspensionForm.numberOfStudents) }).map((_, index) => (
                                    <input
                                        key={index}
                                        type="text"
                                        value={suspensionForm.studentNames[index] || ''}
                                        onChange={(e) => handleStudentNameChange(index, e.target.value)}
                                        placeholder={`學童姓名 ${index + 1}`}
                                        className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-2"
                                    />
                                ))}
                            </div>
                            {renderFormField('停餐開始日期', 'startDate', suspensionForm.startDate, handleSuspensionFormChange, 'date', [], '', minAllowedStartDate)}
                            {renderFormField('停餐結束日期', 'endDate', suspensionForm.endDate, handleSuspensionFormChange, 'date', [], '', suspensionForm.startDate || minAllowedStartDate)}
                            {renderFormField('停餐原因', 'reason', suspensionForm.reason, handleSuspensionFormChange, 'textarea', [], '請說明停餐原因')}
                            <div className="md:col-span-2 flex justify-center mt-6 gap-4">
                                <button
                                    type="submit"
                                    className="btn-primary px-8 py-3 text-lg font-semibold rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                >
                                    送出停餐申請
                                </button>
                                <button
                                    type="button"
                                    onClick={handlePrint}
                                    className="bg-indigo-600 text-white px-8 py-3 text-lg font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                                >
                                    列印申請表
                                </button>
                            </div>
                        </form>

                        <h3 className="text-xl font-bold text-gray-800 mt-10 mb-4 border-b pb-2">已送出的停餐申請</h3>
                        {submittedSuspensions.length === 0 ? (
                            <p className="text-gray-600">目前沒有已送出的停餐申請資料。</p>
                        ) : (
                            <div className="overflow-x-auto">
                                <table className="min-w-full bg-white border border-gray-200 rounded-lg">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">年級</th>
                                            <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">班級</th>
                                            <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">座號</th>
                                            <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">學童姓名</th>
                                            <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">停餐日期</th>
                                            <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">停餐天數</th>
                                            <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">退費金額</th>
                                            <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">原因</th>
                                            <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">送出時間</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-200">
                                        {submittedSuspensions.map((suspension) => (
                                            <tr key={suspension.id}>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900">{suspension.grade}</td>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900">{suspension.class}</td>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900">{suspension.studentId}</td>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900">
                                                    {suspension.studentNames?.filter(name => name).join(', ') || 'N/A'}
                                                </td>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900">
                                                    {suspension.startDate} 到 {suspension.endDate}
                                                </td>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900">{suspension.actualSuspensionDays}</td>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900">{suspension.refundAmount} 元</td>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900">{suspension.reason}</td>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900">
                                                    {suspension.timestamp?.toDate().toLocaleString() || 'N/A'}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </section>
                )}

                {/* Student Health Report System */}
                {currentPage === 'health' && (
                    <section>
                        <h2 className="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">學童身高、體重、視力填報系統</h2>
                        <form onSubmit={handleHealthSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                            {renderFormField('身高 (公分)', 'height', healthForm.height, handleHealthFormChange, 'number', [], '請輸入身高 (例如: 135.5)')}
                            {renderFormField('體重 (公斤)', 'weight', healthForm.weight, handleHealthFormChange, 'number', [], '請輸入體重 (例如: 30.2)')}
                            {renderFormField('左眼視力', 'visionLeft', healthForm.visionLeft, handleHealthFormChange, 'text', [], '請輸入左眼視力 (例如: 1.0)')}
                            {renderFormField('右眼視力', 'visionRight', healthForm.visionRight, handleHealthFormChange, 'text', [], '請輸入右眼視力 (例如: 0.9)')}
                            <div className="md:col-span-2 flex justify-center mt-6">
                                <button
                                    type="submit"
                                    className="btn-primary px-8 py-3 text-lg font-semibold rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                >
                                    送出健康資料
                                </button>
                            </div>
                        </form>

                        <h3 className="text-xl font-bold text-gray-800 mt-10 mb-4 border-b pb-2">已送出的健康資料</h3>
                        {submittedHealthReports.length === 0 ? (
                            <p className="text-gray-600">目前沒有已送出的健康資料。</p>
                        ) : (
                            <div className="overflow-x-auto">
                                <table className="min-w-full bg-white border border-gray-200 rounded-lg">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">身高 (cm)</th>
                                            <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">體重 (kg)</th>
                                            <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">左眼視力</th>
                                            <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">右眼視力</th>
                                            <th className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">送出時間</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-200">
                                        {submittedHealthReports.map((report) => (
                                            <tr key={report.id}>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900">{report.height}</td>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900">{report.weight}</td>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900">{report.visionLeft}</td>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900">{report.visionRight}</td>
                                                <td className="py-3 px-4 whitespace-nowrap text-sm text-gray-900">
                                                    {report.timestamp?.toDate().toLocaleString() || 'N/A'}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </section>
                )}

                {/* Hygiene Documents */}
                {currentPage === 'documents' && (
                    <section>
                        <h2 className="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">衛生組相關文件</h2>
                        <p className="text-gray-600 mb-4">
                            以下是衛生組相關文件的連結。請注意，這些是範例連結，您需要將它們替換為您在 Google 雲端硬碟中實際文件的分享連結。
                        </p>
                        <ul className="list-disc list-inside space-y-3 text-blue-600">
                            <li>
                                <a href="https://docs.google.com/document/d/1_PLACEHOLDER_CLEANING_AREA_ASSIGNMENT/edit?usp=sharing" target="_blank" rel="noopener noreferrer" className="hover:underline">
                                    校園清掃區域班級分配圖表
                                </a>
                            </li>
                            <li>
                                <a href="https://docs.google.com/document/d/1_PLACEHOLDER_SUPERVISOR_ROSTER/edit?usp=sharing" target="_blank" rel="noopener noreferrer" className="hover:underline">
                                    督導人員配置表
                                </a>
                            </li>
                            <li>
                                <a href="https://docs.google.com/document/d/1_PLACEHOLDER_CLASS_ACTIVITY_LUNCH_SUSPENSION/edit?usp=sharing" target="_blank" rel="noopener noreferrer" className="hover:underline">
                                    班級活動申請停餐表
                                </a>
                            </li>
                            <li>
                                <a href="https://docs.google.com/document/d/1_PLACEHOLDER_RECYCLING_PLAN/edit?usp=sharing" target="_blank" rel="noopener noreferrer" className="hover:underline">
                                    資源回收施行計劃
                                </a>
                            </li>
                            <li>
                                <a href="https://docs.google.com/document/d/1_PLACEHOLDER_OTHER_DOCUMENT/edit?usp=sharing" target="_blank" rel="noopener noreferrer" className="hover:underline">
                                    其他相關文件
                                </a>
                            </li>
                        </ul>
                    </section>
                )}
            </main>

            {/* Hidden component for printing */}
            <PrintableSuspensionForm data={printData} ref={printableRef} />
        </div>
    );
}

export default App;
